<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>网盘</title>
<link href="../lib/css/public.css" type="text/css" rel="stylesheet" />
<link href="lib/css/disk.css" type="text/css" rel="stylesheet" />
<link href="../widget/frame/css/frame.css" type="text/css" rel="stylesheet" />

<script type="text/javascript" src="../lib/javascript/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../lib/javascript/jquery.form.min.js"></script>
<script type="text/javascript" src="../widget/frame/javascript/createDialog.js"></script>
<script type="text/javascript" src="lib/javascript/folderCommon.js"></script>
<script type="text/javascript" src="lib/javascript/disk.js"></script>
</head>

<body class="bodyBack">

<!-- Start of toppart -->
<div id="banner" class="fontLeft com-top toDiv">
</div>
<!-- End of toppart -->


<!-- Start of con -->
<div class="comMarginTop01 fontLeft">
	<table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left" valign="top" class="menu-left" id="memuFrame">
        	
        	<div class="menu-line"></div>
            <div class="menu-c" id="navTree">
            </div>
        </td>
        <td align="left" valign="top" class="com-right">
        	<div class="com-rightPosition">
                    <div class="com-optionMenu">
                    <a class="returnHome" title="返回主页" href="index" hidefocus="true"><i></i></a>
                    <a class="closeMenu  close" id="setMenuFrame" title="打开菜单" hidefocus="true"><i></i></a>
                    </div>
                    <div>
                    
						<div class=" com-userDel" style="height:120px">
                        	<div class="com-userDel-ik">
                                <a id="uploader" class="upDataButton" onclick="uploadFile()"><i></i>上传文件</a>
                            </div>
                            <div class="com-in">
                                <div class="com-info address04"><a><p class="com-info-ic"><b><i class="com-icons"></i></b></p><p class="com-info-num">${(fileCount)!}</p><font>我的文件</font></a></div>
                                <div class="com-info address05"><a><p class="com-info-ic"><b><i class="com-icons"></i></b></p><p class="com-info-num">3</p><font>@我的文件</font></a></div>
                            </div>
                            
                        </div>
                        <div>
                        	<div class="disk-option">
                            	<span><a class="create" id="createFolder"><i class="opi-ico create"></i>新建文件夹</a><a onclick="downloadFiles()"><i class="d-icons down"></i>下载</a><a><i class="d-icons send"></i>发送</a>
                            	<a onclick="delFiles()"><i class="d-icons delate"></i>删除</a><a onclick="rename()" id="rename"><i class="d-icons rename"></i>重命名</a><a onclick="move()" id="move"><i class="d-icons move"></i>移动到</a></span>
                                <font class="disk-page"><b id="pageInfo"><em>0/0</em></b><a class="prev" onclick="pageLast()"><i class="page-ico"></i></a><a class="next" onclick="pageNext()"><i class="page-ico"></i></a></font>
                                <font class="disk-change"><a class="shape-ico list check" title="列表展示"></a><a class="shape-ico icon" title="图标展示"></a></font>
                            </div>
                                                        
                            <div class="directory-path">
                                    <div class="path-contents" id="page_local"><a title="根目录" path="">根目录</a><i>»</i><i>»</i><em>&nbsp;</em></div>
                            </div>
                            
                            
                            <div class="disk-content" oncontextmenu="self.event.returnValue=false" onselectstart="return false">
                            	<div class="disk-c-list"><label id="checkboxAll"><i class="disk-checkbox"></i><em>文件名</em></label><span class="time-title">修改时间</span><span class="size-title">大小</span></div>
                                <div id="disk-tainer">
                                
                                </div>    
                            </div>
                        </div>
                                          
                    </div>
            </div>
        </td>
      </tr>
    </table>
</div>
<form id="fileForm" name="fileForm" style="display:none" enctype="multipart/form-data">
	<input id="upFile" name="upFile" type="file" />
</form>
<!-- End of con -->

<!-- Start of footer -->
<div id="footer" class="comMarginTop01 com-footer">
</div>
<!-- End of footer -->
<script type="text/javascript">
	
	var pageNumber=1;
	var pageSize=10;
	var totalPage=1;
	var selFiles=[];
	var path="";
	
	//文件夹点击事件
	var my = new optionFolder();
	my.SetOptions({
		clickFolderBackFun:folderClick,
		resetLsitFun:navClick
	});
	
	$(function() {
		$("#banner").load("../banner?navInfo=m,5");
		$("#navTree").load("../navTree?navInfo=m,5");
		$("#footer").load("../footer");
		$("#memuFrame").show();
		getFileList();
		$("#upFile").change(function() {
			var fileInfo = $("#upFile").val().split('.');
	        var fileType=fileInfo[fileInfo.length-1].toLowerCase();
	        $("#fileForm").ajaxSubmit({
                url: "../disk/uploadFile",
                type: "post",
                data: { path : path},
                dataType: "json",
                resetForm: "true",
                beforeSubmit: function() {
            		var fileHtml='<div class="disk-c-list" typeFile="file" name="loadingFile"><label><i class="disk-checkbox"></i><a class="disk-linka"><b><img src="lib/images/file_type/unknown.gif"/></b><em>文件正在上传</em></a></label><b><img src="lib/images/loading.gif"/></b></div>';
            		$("#disk-tainer").prepend(fileHtml);
            		$("#uploader").removeAttr("onclick");
                },
                success: function(data) {
                    alert(data.Msg);
                    $("#disk-tainer").children()[0].remove();
                    $("#uploader").attr("onclick","uploadFile()");
                    if(data.Result){
	                    var fileHtml='<div class="disk-c-list" typeFile="file" name="'+data.FileName+'"><label><i class="disk-checkbox"></i><a class="disk-linka"><b><img src="lib/images/file_type/'+data.IconPath+'"/></b><em>'+data.FileName+'</em></a></label></div>';
	            		$("#disk-tainer").prepend(fileHtml);
	            		my.reSet();
                    }
                   
                },
                error: function(jqXHR, errorMsg, errorThrown) {
                    alert(errorMsg);
                    $("#disk-tainer").children()[0].remove();
                    $("#uploader").attr("onclick","uploadFile()");
                }
            });	
		});
	});
	
	function getSelFiles(){
		selFiles=[];
		$("#disk-tainer .disk-checkbox").each(function(){
			var type=$(this).parent().parent().attr("typeFile");
			if($(this).hasClass("check")){
				var single = new Object();
				if(type=="file"){
					single["Type"]="file";
					single["Name"]=$(this).parent().parent().attr("name");
					selFiles.push(single);
				}else if(type="folder"){
					single["Type"]="folder";
					single["Name"]=$(this).parent().parent().attr("path");
					selFiles.push(single);
				}
			}
		});
	}
	
	function rename(){
		getSelFiles();
		if(selFiles.length==1){
			/*重命名事件*/
			DialogRenameFile();
		}else if(selFiles.length>1){
			alert("只能选择单一文件或文件夹进行操作！");
		}else{
			alert("请选择文件或者文件夹！");
		}
	}
	
	function move(){
		getSelFiles();
		if(selFiles.length>0){
			DialogMoveFile();
		}else{
			alert("请选择文件或者文件夹！");
		}
	}
	
	function downloadFiles(){
		getSelFiles();
		if(selFiles.length>0){
			$.ajax({
	            url: "../disk/downFiles",
	            type: "GET",
	            dataType: "json",
	            data: {
	            	files : JSON.stringify(selFiles),
	            	path : path
	            	},
	            success: function(data) {
	            	for (var i=0;i<data.DownFileList.length;i++){
	            		var fileURL=data.CurrentUrl+data.DownFileList[i];
	                    try{
	                   	   var elemIF = document.createElement("iframe");
	                   	   elemIF.src = fileURL;
	                   	   elemIF.style.display = "none";
	                   	   document.body.appendChild(elemIF);
	                    }catch(e){
	                    	
	                    }	
	            	}
	            	
	            }
			});
		}else{
			alert("请选择文件或者文件夹！");
		}
	}
	
	function delFiles(){
		getSelFiles();
		if(selFiles.length>0){
			$.ajax({
	            url: "../disk/delFiles",
	            type: "GET",
	            dataType: "json",
	            data: {
	            	files : JSON.stringify(selFiles),
	            	path : path
	            	},
	            success: function(data) {
	            	if(data.Result){
						removeFileList(selFiles);
						alert(data.Msg);
	            	}else{
	            		alert(data.Msg);
	            	}
	            }
			});
		}else{
			alert("请选择文件或者文件夹！");
		}
	}
	
	function removeFileList(files){
		$("#disk-tainer").children().each(function(){
			var typeFile = $(this).attr("typeFile");
			var key="";
			var $this=$(this);
			if(typeFile == "file"){
				key = $this.attr("name");
			}else if(typeFile == "folder"){
				key = $this.attr("path");
			}
			$(files).each(function(){
		        if(this.Name==key){
		        	$this.remove();
		        }
		    });			
		});
	}
	
	function uploadFile(){
		$("#upFile").click();		
	}
	
	function addFolder(folderName){
		$.ajax({
	        url: "../disk/addFolder",
	        type: "GET",
	        dataType: "json",
	        data: {
	        	folderName:folderName,
	        	path:path
	        	},
	        success: function(data) {
	        	if(data.Result){
	        		var folderHtml='<div class="disk-c-list" typeFile="folder" path="'+folderName+'"><label><i class="disk-checkbox"></i><a class="disk-linka"><b><img src="lib/images/file_type/folder/folder.gif"/></b><em>'+folderName+'</em></a></label><span class="time-title">2014-06-07</span><span class="size-title">0</span></div>';
	        		$("#disk-tainer").prepend(folderHtml);
	        		my.reSet();
	        	}else{
	        		alert(data.Msg);
	        	}
	        },
	        error: function (jqXHR, textStatus, errorThrown) {
	            alert(jqXHR.responseText);
	        }
		});
	}
	
	function getFileList(){
		$.ajax({
            url: "../disk/fileManager",
            type: "GET",
            dataType: "json",
            data: {
            	pageNumber: pageNumber,
				pageSize: pageSize,
				path: path
            	},
            success: function(data) {
				//列表信息
				var fileList='';
				for(var i=0;i<data.file_list.length;i++){
					if(data.file_list[i].is_dir){ //文件夹
						fileList+='<div class="disk-c-list" typeFile="folder" path="'+data.file_list[i].filename+'"><label><i class="disk-checkbox"></i><a class="disk-linka"><b><img src="lib/images/file_type/'+data.file_list[i].icon_path+'"/></b><em>'+data.file_list[i].filename+'</em></a></label><span class="time-title">'+data.file_list[i].datetime+'</span><span class="size-title">'+data.file_list[i].filesize+'</span></div>';
					}else{
						fileList+='<div class="disk-c-list" typeFile="file" dir="'+data.current_dir_path+'" name="'+data.file_list[i].filename+'"><label><i class="disk-checkbox"></i><a class="disk-linka"><b><img src="lib/images/file_type/'+data.file_list[i].icon_path+'"/></b><em>'+data.file_list[i].filename+'</em></a></label><span class="time-title">'+data.file_list[i].datetime+'</span><span class="size-title">'+data.file_list[i].filesize+'</span></div>';
					}
				}
				$("#disk-tainer").html(fileList);
            	//分页信息
            	totalPage = Math.ceil(data.total_count/pageSize);
            	pageNumber = data.page_number;	
            	var pageInfo = '<em>'+pageNumber+'/'+totalPage+'</em>';
				$("#pageInfo").html(pageInfo);
				//设置文件夹事件
				my.reSet();
            },
           	error: function (jqXHR, textStatus, errorThrown) {
                alert(jqXHR.responseText);
            }
        });
	}
	
	function folderClick(){
		path+=$(this).parent().parent().attr("path")+'/';
		pageNumber=1;
		var pathArray=path.split("/");
		var pathList='<a title="根目录" path="">根目录</a><i>»</i>';
		var dPath="";
		for (var i=0;i<pathArray.length-1;i++){
			dPath+=pathArray[i]+"/";
			pathList+='<a title="'+pathArray[i]+'" path="'+dPath+'">'+pathArray[i]+'</a><i>»</i>';
		}
		pathList+='<i>»</i><em>&nbsp;</em>';
		$("#page_local").html(pathList);
		getFileList();
	}
	
	function navClick(){
		path=$(this).attr("path");
		pageNumber=1;
		getFileList();
	}
	
	function pageNext(){
		if(pageNumber>=totalPage)
			return;
		pageNumber++;
		getFileList();
	}
	
	function pageLast(){
		if(pageNumber<=1)
			return;			
		pageNumber--;
		getFileList();
	}
</script>
</body>
</html>
