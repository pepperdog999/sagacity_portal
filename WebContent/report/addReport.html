<div class="report-s">
	<h5><font>新建简报</font><span></span></h5>
    <div class="report-s-con">
    		
            
            <div class="del">
            	<div class="title"><label>简报标题：</label><input id="title" type="text" class="meeting-input01"/></div>
                
                <table width="100%" border="0" cellspacing="1" cellpadding="0" class="meetingDel-tab">
                  <tr>
                    <th>简报内容：</th>
                    <td><textarea id="content" cols="" rows="" class="meeting-textarea"></textarea></td>
                  </tr>
                  <tr>
                    <th>发送人：</th>
                    <td>
                    	<div class="relative">
	                    	<ul class="upNameList" style="width:450px;" id="sendObject"></ul><a class="process-icons lxr bindDialog" data-type="user"></a>
	                        <div class="userListMore" id="moreDiv"></div>
	                    </div>
                    </td>
                  </tr>
                </table>

                <div class="fileFont"><h4><img src="lib/images/links.png" width="17" height="17" />简报附图：</h4></div>
                <div class="img">                	
                	<div id="attachList">

                    </div>
                    <a id="attUpload" onclick="uploadAttach()" class="addList-oper" title="添加图片"></a>
                    <form id="attachForm" name="attachForm" style="display:none" enctype="multipart/form-data">
		      			<input id="attachFile" name="attachFile" type="file" />
		      		</form>
              	</div>
                <div class="meeting-linkFrame"><a onclick="createReporting()" class="meeting-subbtn">确定</a><a class="meeting-cancelbtn">取消</a></div>
            </div>

    </div>
</div>

<script type="text/javascript">
	jugDialogPage();
	var indexData=[];
	
	function checkData(){
		if ($("#title").val()=='' || $("#title").val()==null){
			alert('请设简报标题！');
			return false;
		}else if ($("#content").val()=='' || $("#content").val()==null){
			alert('请设置简报内容！');
			return false;
		}else if (indexData.length==0){
			alert('请选择发送人！');
			return false;
		}
		return true;
	}
	
	function createReporting(){
		if(!checkData()){
			return;
		}
		//附件数组
		var attachArray = new Array();
		$('#attachList').find(".addList").each(function(item){
			attachArray.push($(this).attr('attach-id'));
		});
		$.ajax({
            url: "../report/addReporting",
            type: "GET",
            dataType: "json",
            data: {
            	title : $("#title").val(),
            	content : $("#content").val(),
            	attachArray : attachArray.toString(),
            	indexData : JSON.stringify(indexData)
            },
            success: function(data) {
            	alert(data.Msg);
            }
		});
		
	}
	
	//人员选择确定
	function chooseUserConfirm(){
		var userList=document.getElementById("dialogIframe").contentWindow.submitLsit();
		
		var html1='';
		var html2='<ul class="upNameList reStyle">';
		for(var i=0;i<userList.length;i++){
			if(i<=5){
    			html1+='<li data-id="'+userList[i].ID+'" onclick="removeUser(this)"><b>'+userList[i].Name+'</b><i></i></li>';
			}else{
				html2+='<li data-id="'+userList[i].ID+'" onclick="removeUser(this)"><b>'+userList[i].Name+'</b><i></i></li>'
			}
    		var single = new Object();
    		single["Type"]=2;
			single["ID"]=userList[i].ID;
			single["Name"]=userList[i].Name;
			indexData.push(single);
		}
		html1+='<li onclick="more(this)" class="more"><a title="显示更多"></a></li>';
		html2+='</ul>'
    	$("#sendObject").html(html1);
		$("#moreDiv").html(html2);
	}
	
	function more(obj){
		if($(obj).hasClass("up")){
			$(obj).removeClass("up");
			$("#moreDiv").hide();
		}else{
			$(obj).addClass("up");
			$("#moreDiv").show();
		}
	}
	
	function removeUser(obj){
		if(indexData.length>1){
			for(var i=0;i<indexData.length;i++){
				if(indexData[i]["ID"]==$(obj).attr("data-id")){
					indexData.splice(i,1);
				}
			}
			$(obj).remove();	
		}else{
			alert("不允许删除！");
		}
		
	}
	
	$(function(){
		$("#attachFile").change(function() {
			var fileInfo = $("#attachFile").val().split('.');
	        var fileType = fileInfo[fileInfo.length-1].toLowerCase();
	        if((fileType =='jpg' || fileType=='jpeg' || fileType=='gif' || fileType=='bmp' || fileType=='png')){ //控制只能上传图片附件
	        	$("#attachForm").ajaxSubmit({
	                url: "../report/uploadAttach?reportingID=0",
	                type: "post",
	                dataType: "json",
	                resetForm: "true",
	                beforeSubmit: function() {
	                	$("#attUpload").hide();
	                },
	                success: function(data) {
	                    if(data.Result){
	                    	alert(data.Msg);
	                    	$("#attUpload").show();
	                    	var imgURL = data.resourceUrl+data.AttachInfo.AttachURL;
	                    	var html='<div onclick="viewAttach(this)" class="addList upimg" attach-id="'+data.AttachInfo.AttachID+'"><a class="free" onclick="delAttach(this)" title="移除此图片"></a><p class="pImg"><img src="'+imgURL+'"></p></div>';
							$("#attachList").prepend(html);
	                    }else{
	                    	alert(data.Msg);
	                    	$("#attUpload").show();
	                    }
	                },
	                error: function(jqXHR, errorMsg, errorThrown) {
	                    alert(errorMsg);
	                }
	            });
	        }else{
	        	alert("请选择图片文件！");
	        	return;
	        }
		});
	});

	function uploadAttach(){
		$("#attachFile").click();
	}

	function delAttach(obj){
		var attachID= $(obj).parent().attr("attach-id");
		if(attachID>0){
			$.ajax({
	            url: "../report/delAttachFile",
	            type: "GET",
	            dataType: "json",
	            data: {
					attachID : attachID
	            	},
	            success: function(data) {
	            	if(data.Result){
						alert(data.Msg);
						$(obj).parent().remove();
	            	}else{
	            		alert(data.Msg);	
	            	}                            	
	            }
			});
		}else{
			alert("请选择需要删除的会议附件！");
		}
	}
</script>