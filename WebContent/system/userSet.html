<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>用户设置</title>
<link href="../lib/css/public.css" type="text/css" rel="stylesheet" />
<link href="lib/css/userset.css" type="text/css" rel="stylesheet" />
<link href="../widget/frame/css/frame.css" type="text/css" rel="stylesheet" />

<script type="text/javascript" src="../lib/javascript/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../widget/frame/javascript/createDialog.js"></script>
<script type="text/javascript" src="lib/javascript/userset.js"></script>
</head>

<body class="bodyBack">

<!-- Start of toppart -->
<div id="banner" class="fontLeft com-top toDiv">
</div>
<!-- End of toppart -->


<!-- Start of con -->
<div class="comMarginTop01 fontLeft">
	<table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left" valign="top" class="menu-left" id="memuFrame">
        	
        	<div class="menu-line"></div>
            <div class="menu-c" id="navTree">
            </div>
        </td>
        <td align="left" valign="top" class="com-right">
        	<div class="com-rightPosition">
        	<div class="com-optionMenu">
        		<a class="returnHome" title="返回主页" href="../user/userCustomized" hidefocus="true"><i></i></a>
        		<a class="closeMenu close" id="setMenuFrame" title="打开菜单" hidefocus="true"><i></i></a>
        	</div>
        	<div class="com-tit" style="display:none;"><font>个人信息</font><em>/</em><b>User Message</b></div>
            <div>
            
            	
                <div class="relativeDiv per">
            	
                            <div class="perImg">
                                <div class="perImg-b"><img src="${(resourceUrl)!}${(userInfo.UserID)!}${(headerFix)!}" onerror="javascript:this.src='../user/header/header.png'"/></div>
                            </div>
                            <div class="perImg-edit"><a class="bindDialog"  data-type="upImg">[编辑头像]</a></div>
                            <div class="perLineBox"><div class="perLine">个人资料设置</div></div>
                            <div class="perCon marginTop01">
                                 <div class="perCon-bor">
                                     <h5 class="perTitle">密码修改</h5>
                                     <div>
                                       <div class="perPub"><code>原始密码：</code><input id="oldPwd" type="password" class="com-tabInput" style="width:200px;"/><span></span></div>
                                       <div class="perPub"><code>新密码：</code><input id="newPwd" type="password" class="com-tabInput" style="width:200px;"/><span></span></div>
                                         <div class="perPub"><code>确认密码：</code><input id="confirmPwd" type="password" class="com-tabInput" style="width:200px;"/><span></span></div>
                                     </div>
                                     <div class="perBtn-box"><button class="com-lookBtn" onclick="changePwd()">确认修改</button></div>
                                 </div>
                                 <form id="userForm" method="post">
                                 <div class="perCon-bor">
                                     <h5 class="perTitle">用户资料</h5>
                                     <div>
                                       <div>
                                       	   <input type="hidden" name="userInfo.UserID" value="${(userInfo.UserID)!}"/>
                                       	   <input type="hidden" id="settingID" name="userSetting.SettingID" value="${(userSetting.SettingID)?default(0)}"/>
                                       </div>                          
                                       <div class="perPub"><code>系统账号：</code><em>${(userInfo.LoginName)!}</em></div>
                                       <div class="perPub"><code>显示名：</code><input name="userInfo.Caption" type="text" class="com-tabInput" style="width:200px;" value="${(userInfo.Caption)!}"/><span><i class="tips-icons true-icons"></i>输入校验!</span></div>
                                       <div class="perPub"><code>登录首选模块：</code>
	                                       <select id="selector1" name="userSetting.DefaultModule">
	                                       	 <#list modules as module>
	                                       	 	<option value="m,${(module.ModuleID)!}">${(module.Caption)!}</option>
	                                         </#list>
	                                         <#list corpApps as app>
	                                         	<option value="a,${(app.AppID)!}">${(app.AppName)!}</option>
											</#list>
	                                       </select>
                                       </div>
                                       <div class="perPub"><code>用户昵称：</code><input name="userInfo.NickName" type="text" class="com-tabInput" style="width:200px;" value="${(userInfo.NickName)!}"/><span><i class="tips-icons true-icons"></i>输入校验!</span></div>
                                       <div class="perPub"><code>个性签名：</code><textarea name="userInfo.Sign" cols="" rows="" class="com-tabTextarea" style="width:400px;">${(userInfo.Sign)!}</textarea><span><i class="tips-icons true-icons"></i>输入校验!</span></div>
                                     </div>
                                     <div class="perBtn-box"><button class="com-lookBtn" onclick="submitUserForm()">确认修改</button></div>
                                 </div>
                                 </form>
                            </div>
                            <div class="perCon-bor-mor">
                                <p class="perCon-bor-mor01"></p>
                                <p class="perCon-bor-mor02"></p>
                                <p class="perCon-bor-mor03"></p>
                                <p class="perCon-bor-mor04"></p>
                            </div>
                  </div>
                
                
            </div>
            </div>
        </td>
      </tr>
    </table>
</div>
<!-- End of con -->

<!-- Start of footer -->
<div id="footer" class="comMarginTop01 com-footer">
</div>
<!-- End of footer -->
<script type="text/javascript">
		
	$(function() {
		$("#banner").load("../banner?navInfo=m,99");
		$("#navTree").load("../navTree?navInfo=m,99");
		$("#footer").load("../footer");
		$("#memuFrame").show();
		
		//设置首选模块选中样式
		$("#selector1 option[value='${(userSetting.DefaultModule)!}']").attr("selected","selected");
		
		$("#oldPwd").blur(function() {
			var html='';
			$.ajax({
				type: "POST",
				url:"../system/checkOldPwd",
				dataType: "json",
				data: {
					userID : '${(userInfo.UserID)!}',
					oldPwd : $("#oldPwd").val()
					},
				success: function(data){
					if(data.Result){
						html='<i class=\"tips-icons true-icons\"></i>'+data.Msg;
						setTip($("#oldPwd"),html);
					}else{
						html='<i class=\"tips-icons error-icons\"></i>'+data.Msg;
						setTip($("#oldPwd"),html);
					}					
				}
			});
		});
		$("#newPwd").blur(function() {
			var html='';
			if($("#newPwd").val()==''){
				html='<i class=\"tips-icons warn-icons\"></i>新密码不能为空!';
				setTip($("#newPwd"),html);
			}else if($("#newPwd").val().length<6){
				html='<i class=\"tips-icons warn-icons\"></i>新密码长度需大于6个字符!';
				setTip($("#newPwd"),html);
			}
			else{
				html='<i class=\"tips-icons true-icons\"></i>新密码输入正确!';
				setTip($("#newPwd"),html);
			}
		});
		$("#confirmPwd").blur(function() {
			var html='';
			if($("#confirmPwd").val()!=$("#newPwd").val()){
				html='<i class=\"tips-icons error-icons\"></i>确认密码输入不一致!';
				setTip($("#confirmPwd"),html);
			}else{
				html='<i class=\"tips-icons true-icons\"></i>确认密码输入正确!';
				setTip($("#confirmPwd"),html);
			}
		});
	});
	
	function submitUserForm() {
		$.ajax({
			url : "../system/updateUserSet",
			type : "post",
			data : $("#userForm").serialize(),
			dataType : "json",
			async: false,
			success : function(data) {
				if(data.Result){
					$("#settingID").val(data.SettingID);
				}
				alert(data.Msg);
			},
			error : function(jqXHR, textStatus, errorThrown) {
				alert(jqXHR.responseText);
			}
		});
	}
	
	function changePwd() {
		if($("#oldPwd").parent().find("i").attr("class")=='tips-icons true-icons' && $("#newPwd").parent().find("i").attr("class")=='tips-icons true-icons' && $("#confirmPwd").parent().find("i").attr("class")=='tips-icons true-icons'){
			$.ajax({
				type: "POST",
				url:"../system/changePwd",
				dataType: "json",
				data: {
					userID : '${(userInfo.UserID)!}',
					oldPwd : $("#oldPwd").val(),
					newPwd : $("#newPwd").val()
					},
				success: function(data){
					if(data.ExecuteState){
						alert(data.Msg);
					}else{
						alert(data.Msg);
					}					
				}
			});
		}else{
			alert("密码信息不完整，请检查通过后重新提交修改！");
		}
		
	}
	
	function setTip(obj,msg){
		obj.parent().find("span").empty();
		obj.parent().find("span").html(msg);		
	}
	
</script>
</body>
</html>
