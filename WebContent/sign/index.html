<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>云签到</title>
<link href="../lib/css/public.css" type="text/css" rel="stylesheet" />
<link href="lib/css/sign.css" type="text/css" rel="stylesheet" />
<script type="text/javascript" src="../lib/javascript/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="lib/javascript/sign.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=RjGyXdLnqs1ZYz2MOixYziSV"></script>
</head>

<body class="bodyBack">

<!-- Start of toppart -->
<div id="banner" class="fontLeft com-top toDiv">
</div>
<!-- End of toppart -->


<!-- Start of con -->
<div class="comMarginTop01 fontLeft">
	<table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left" valign="top" class="menu-left" id="memuFrame">
        	
        	<div class="menu-line"></div>
            <div class="menu-c" id="navTree">
            </div>
        </td>
        <td align="left" valign="top" class="com-right">
        	<div class="com-rightPosition">
            	<div class="com-optionMenu">
            		<a class="returnHome" title="返回主页" href="index" hidefocus="true"><i></i></a>
            		<a class="closeMenu close" id="setMenuFrame" title="打开菜单"><i></i></a>
            	</div>
        		<div class="com-member">
                	<div class="sign-ti">
                		<span><i id="signCount">0</i></span>
                		<font><a class="prev" href="javascript:dayLast()" title="上一日"></a><b id="calTitle"></b><a class="next" href="javascript:dayNext()" title="下一月"></a></font></div>
	                    <div class="sign-k">
	                    	<div class="sign-borderTop"></div>
						    <div class="sign-borderBottom"></div>
						    <div class="sign-map" id ="signMap"></div>
						    <div class="sign-text" id="signNote"></div>
						    <div class="sign-borderLeft"></div>
						    <div class="sign-borderRight"></div>
	                    </div>
                </div>
            </div>
        </td>
      </tr>
    </table>
</div>
<!-- End of con -->

<!-- Start of footer -->
<div id="footer" class="comMarginTop01 com-footer">
</div>
<!-- End of footer -->
<script type="text/javascript">
	
	var nowDate = "";
	// 百度地图API功能
	var map = new BMap.Map("signMap");
	//map.centerAndZoom(new BMap.Point(104.05241,30.67752), 14);
	map.addControl(new BMap.NavigationControl());               // 添加平移缩放控件
	map.addControl(new BMap.ScaleControl());                    // 添加比例尺控件
	map.addControl(new BMap.OverviewMapControl());              //添加缩略地图控件
	map.enableScrollWheelZoom();                            //启用滚轮放大缩小
	
	$(function() {
		$("#banner").load("../banner?navInfo=a,15");
		$("#navTree").load("../navTree?navInfo=a,15");
		$("#footer").load("../footer");
		$("#memuFrame").show();
		
		//初始化日历年月
		nowDate ="${(nowDate)!}";
		initSignMap();
		
	});
	
	var createMark = function(lng, lat, info_html) {  
        var _marker = new BMap.Marker(new BMap.Point(lng, lat));  
        _marker.addEventListener("click", function(e) {  
            this.openInfoWindow(new BMap.InfoWindow(info_html));  
        });  
        _marker.addEventListener("mouseover", function(e) {  
            this.setTitle("位于: " + lng + "," + lat);  
        });  
        return _marker;  
    }; 
    
	function initSignMap(){
		$("#calTitle").html(nowDate);
		
		$.ajax({
            url: "../sign/getSignList",
            type: "GET",
            dataType: "json",
            data: {
            	signDate: nowDate
            	},
            success: function(data) {
            	$("#signCount").html(data.list.length);
            	if(data.list.length>0){
            		$("#signMap").show();
            		$("#signNote").hide();
            		var cp = data.list[0].SignCoordinate.split(",");
            		map.centerAndZoom(new BMap.Point(cp[1],cp[0]), 12);	
            		for(var i=0;i<data.list.length;i++){
                		var ca = data.list[i].SignCoordinate.split(",");
                		var sContent = '<br>签到地点：'+data.list[i].SignAddress+'<br>签到时间：'+data.list[i].SignTime;
                		var marker = createMark(ca[1],ca[0], sContent);  
                        map.addOverlay(marker);
                	}
            	}else{
            		$("#signMap").hide();
            		$("#signNote").show();
            	}
            }
		});
		
	}
	
	Date.prototype.dateAdd = function(interval,number) 
	{ 
	    var d = this; 
	    var k={'y':'FullYear', 'q':'Month', 'm':'Month', 'w':'Date', 'd':'Date', 'h':'Hours', 'n':'Minutes', 's':'Seconds', 'ms':'MilliSeconds'}; 
	    var n={'q':3, 'w':7}; 
	    eval('d.set'+k[interval]+'(d.get'+k[interval]+'()+'+((n[interval]||1)*number)+')'); 
	    return d; 
	}
	
	Date.prototype.Format = function (fmt) { //author: meizz 
	    var o = {
	        "M+": this.getMonth() + 1, //月份 
	        "d+": this.getDate(), //日 
	        "h+": this.getHours(), //小时 
	        "m+": this.getMinutes(), //分 
	        "s+": this.getSeconds(), //秒 
	        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
	        "S": this.getMilliseconds() //毫秒 
	    };
	    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
	    for (var k in o)
	    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
	    return fmt;
	}
	
	function dayLast(){
		var dt = new Date(nowDate);
		dt.dateAdd("d",-1);
		nowDate=dt.Format("yyyy-MM-dd");
		initSignMap();
	}
	
	function dayNext(){
		var dt = new Date(nowDate);
		dt.dateAdd("d",1);
		nowDate=dt.Format("yyyy-MM-dd");
		initSignMap();
	}
</script>
</body>
</html>
